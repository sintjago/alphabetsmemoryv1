<script>
    let synth = window.speechSynthesis;
    let sequence = [];
    let playerSequence = [];
    let gameInProgress = false;
    let currentRound = 0;
    let score = 0;
    let currentUtterance = null;
    let speed = 1.5; // Default speed
    let gameMode = 'alphabet+sound'; // Default mode

    // Alphabets for different languages (added Greek - 'el')
    const alphabets = {
        el: "Α Β Γ Δ Ε Ζ Η Θ Ι Κ Λ Μ Ν Ξ Ο Π Ρ Σ Τ Υ Φ Χ Ψ Ω".split(" ")
    };

    const language = 'el'; // Force Greek
    const voiceLang = 'el-GR'; // Greek voice for TTS

    const symbolsContainer = document.getElementById('symbolGrid');
    const symbolCountSelect = document.getElementById('symbolCount');

    function populateSymbolCountOptions() {
        const alphabet = alphabets[language];
        symbolCountSelect.innerHTML = '';
        for (let i = 1; i <= alphabet.length; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i === alphabet.length ? `Max (${i})` : i;
            symbolCountSelect.appendChild(option);
        }
        symbolCountSelect.value = 6;
    }

    function generateSymbolGrid(selectedCount) {
        symbolsContainer.innerHTML = '';
        const alphabet = alphabets[language];
        const shuffled = [...alphabet].sort(() => Math.random() - 0.5).slice(0, selectedCount);
        shuffled.forEach(letter => {
            const div = document.createElement('div');
            div.className = 'symbol';
            div.textContent = letter;
            div.onclick = () => handleSymbolClick(div);
            symbolsContainer.appendChild(div);
        });
    }

    function highlightSymbol(div) {
        if (gameMode !== 'sound-only') {
            div.classList.add('highlight');
            setTimeout(() => div.classList.remove('highlight'), 500 / speed);
        }
    }

    function clickFeedback(div) {
        div.classList.add('clicked');
        setTimeout(() => div.classList.remove('clicked'), 500);
    }

    function speakSymbol(symbol) {
        if (currentUtterance) synth.cancel();
        currentUtterance = new SpeechSynthesisUtterance(symbol);
        currentUtterance.lang = voiceLang;
        currentUtterance.rate = speed;
        synth.speak(currentUtterance);
    }

    function getRandomSymbol() {
        const i = Math.floor(Math.random() * symbolsContainer.children.length);
        return symbolsContainer.children[i];
    }

    function playSequence() {
        let i = 0;
        const interval = setInterval(() => {
            if (i >= sequence.length) return clearInterval(interval);
            const div = sequence[i];
            highlightSymbol(div);
            if (gameMode !== 'alphabet-only') speakSymbol(div.textContent);
            i++;
        }, 1000 / speed);
    }

    function startGame() {
        gameInProgress = true;
        score = 0;
        sequence = [];
        currentRound = 0;
        playerSequence = [];
        document.getElementById('gameMessage').textContent = '';
        document.getElementById('scoreDisplay').textContent = `Points So Far: ${score}`;
        nextRound();
    }

    function nextRound() {
        currentRound++;
        playerSequence = [];
        const newSymbol = getRandomSymbol();
        sequence.push(newSymbol);
        setTimeout(() => playSequence(), 1000 / speed);
    }

    function updateScore() {
        score += currentRound * 10 * speed;
        document.getElementById('scoreDisplay').textContent = `Points So Far: ${score}`;
    }

    function endGame() {
        gameInProgress = false;
        document.getElementById('gameMessage').textContent = `Game Over! Your total score: ${score}`;
    }

    function handleSymbolClick(div) {
        clickFeedback(div);
        speakSymbol(div.textContent);
        if (!gameInProgress) return;
        playerSequence.push(div);
        const step = playerSequence.length - 1;
        if (div !== sequence[step]) return endGame();
        if (playerSequence.length === sequence.length) {
            updateScore();
            nextRound();
        }
    }

    function refreshGrid() {
        const count = parseInt(symbolCountSelect.value);
        generateSymbolGrid(count);
    }

    document.getElementById('symbolCount').addEventListener('change', refreshGrid);
    document.querySelectorAll('input[name="mode"]').forEach(r => {
        r.addEventListener('change', () => {
            gameMode = document.querySelector('input[name="mode"]:checked').value;
            refreshGrid();
        });
    });

    document.getElementById('startGameButton').addEventListener('click', startGame);
    document.getElementById('speed').addEventListener('change', (e) => {
        speed = parseFloat(e.target.value);
    });

    document.getElementById('randomizeSymbolsButton').addEventListener('click', refreshGrid);

    // Initialize for Greek
    populateSymbolCountOptions();
    generateSymbolGrid(6);
</script>
